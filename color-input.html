<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="color-input-overlay.html">

<dom-module id="color-input">
  <template strip-whitespaces>
    <style>
      :host {
        display: block;
        width: 100%;
      }

      #inputContainer {
        box-sizing: border-box;
        padding-left: 26px;
        position: relative;
        width: 100%;
      }

      #colorSwatch {
        border-radius: 50%;
        border: 1px solid #666;
        bottom: 0;
        cursor: pointer;
        height: 16px;
        left: 0;
        margin: auto;
        position: absolute;
        top: 0;
        width: 16px;
      }
    </style>

    <div id="inputContainer" >
      <div id="colorSwatch" on-click="_onSwatchClicked" style$="[[_computeColorPreviewStyle(_value)]]"></div>
      <slot id="slot" slot="input"></slot>
    </div>

  </template>
</dom-module>

<script>

  class ColorInput extends Polymer.Element {

    static get is() {return 'color-input';}

    static get config() {
      return {
        properties: {

          _value: String,

          _overlay: Object          

        }
      };
    }

    get input() {
      if (!this._input) {
        this._input = this.$.slot.assignedNodes({flattern: true}).filter(node => {
          return node.nodeType === 1;
        })[0];
      }
      return this._input;
    }

    connectedCallback() {
      super.connectedCallback();

      setTimeout(_ => {
        this._value = this.input.value;
      });
    }

    _onSwatchClicked(event) {
      if (this._overlay) {
        this._overlay.remove();
      } else {
        this._value = this.input.value;

        this._overlay = document.createElement('color-input-overlay');
        this._overlay.onDetach = _ => {
          this._overlay = null;
        };
        this._overlay.value = this.input.value;
        this._overlay.positionTarget = this.$.colorSwatch;
        this._overlay.open();

        this._overlay.addEventListener('value-changed', _ => {
          this.input.value = this._overlay.value;
          this._value = this.input.value;
        });
      }
    }

    _computeColorPreviewStyle(_value) {
      return `background-color: ${_value};`
    }

  }

  customElements.define(ColorInput.is, ColorInput);

</script>
